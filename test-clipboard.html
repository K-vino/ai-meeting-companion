<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>VMD-AI Clipboard Test</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background: #f5f5f5;
        }
        .header {
            background: #4CAF50;
            color: white;
            padding: 20px;
            border-radius: 12px;
            margin-bottom: 20px;
            text-align: center;
        }
        .test-section {
            background: white;
            padding: 20px;
            border-radius: 12px;
            margin-bottom: 20px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        .test-button {
            background: #2196F3;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            cursor: pointer;
            margin: 8px;
            font-size: 14px;
        }
        .test-button:hover {
            background: #1976D2;
        }
        .result {
            background: #f9f9f9;
            padding: 12px;
            border-radius: 8px;
            margin-top: 12px;
            font-family: monospace;
            white-space: pre-wrap;
        }
        .success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        .error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        .info {
            background: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>üß™ VMD-AI Clipboard Test</h1>
        <p>Testing clipboard functionality in different environments</p>
    </div>

    <div class="test-section">
        <h2>üîß Environment Detection</h2>
        <div id="environment-info" class="result info">Checking environment...</div>
    </div>

    <div class="test-section">
        <h2>üìã Clipboard API Tests</h2>
        <button class="test-button" onclick="testModernClipboard()">Test Modern Clipboard API</button>
        <button class="test-button" onclick="testFallbackMethod()">Test Fallback Method</button>
        <button class="test-button" onclick="testManualCopy()">Test Manual Copy Dialog</button>
        <div id="clipboard-results" class="result">Click a test button to see results...</div>
    </div>

    <div class="test-section">
        <h2>üéØ VMD-AI Integration Test</h2>
        <button class="test-button" onclick="testVMDAIClipboard()">Test VMD-AI Clipboard Function</button>
        <div id="vmdai-results" class="result">Click to test the actual VMD-AI clipboard function...</div>
    </div>

    <script>
        // Check environment on load
        document.addEventListener('DOMContentLoaded', () => {
            checkEnvironment();
        });

        function checkEnvironment() {
            const info = document.getElementById('environment-info');
            let envInfo = '';

            envInfo += `üåê User Agent: ${navigator.userAgent}\n`;
            envInfo += `üîí Secure Context: ${window.isSecureContext}\n`;
            envInfo += `üìã Clipboard API: ${navigator.clipboard ? 'Available' : 'Not Available'}\n`;
            envInfo += `üîë Permissions API: ${navigator.permissions ? 'Available' : 'Not Available'}\n`;
            envInfo += `üìç Location: ${window.location.href}\n`;
            envInfo += `üõ°Ô∏è CSP: ${document.querySelector('meta[http-equiv="Content-Security-Policy"]') ? 'Present' : 'Not Present'}\n`;

            info.textContent = envInfo;
            info.className = 'result info';
        }

        async function testModernClipboard() {
            const results = document.getElementById('clipboard-results');
            const testText = 'VMD-AI Modern Clipboard Test - ' + new Date().toLocaleTimeString();

            try {
                if (!navigator.clipboard) {
                    throw new Error('Clipboard API not available');
                }

                if (!window.isSecureContext) {
                    throw new Error('Not in secure context (HTTPS required)');
                }

                await navigator.clipboard.writeText(testText);
                results.textContent = `‚úÖ SUCCESS: Modern Clipboard API worked!\nText copied: "${testText}"`;
                results.className = 'result success';

                // Try to read back
                try {
                    const readText = await navigator.clipboard.readText();
                    results.textContent += `\n‚úÖ Read back: "${readText}"`;
                } catch (readErr) {
                    results.textContent += `\n‚ö†Ô∏è Could not read back (permission denied): ${readErr.message}`;
                }

            } catch (error) {
                results.textContent = `‚ùå FAILED: ${error.message}`;
                results.className = 'result error';
            }
        }

        function testFallbackMethod() {
            const results = document.getElementById('clipboard-results');
            const testText = 'VMD-AI Fallback Test - ' + new Date().toLocaleTimeString();

            try {
                // Create temporary textarea
                const textArea = document.createElement('textarea');
                textArea.value = testText;
                textArea.style.position = 'fixed';
                textArea.style.left = '-999999px';
                textArea.style.top = '-999999px';
                textArea.style.opacity = '0';

                document.body.appendChild(textArea);
                textArea.focus();
                textArea.select();
                textArea.setSelectionRange(0, testText.length);

                const successful = document.execCommand('copy');
                document.body.removeChild(textArea);

                if (successful) {
                    results.textContent = `‚úÖ SUCCESS: Fallback method worked!\nText copied: "${testText}"`;
                    results.className = 'result success';
                } else {
                    results.textContent = `‚ùå FAILED: execCommand returned false`;
                    results.className = 'result error';
                }

            } catch (error) {
                results.textContent = `‚ùå FAILED: ${error.message}`;
                results.className = 'result error';
            }
        }

        function testManualCopy() {
            const results = document.getElementById('clipboard-results');
            const testText = 'VMD-AI Manual Copy Test - ' + new Date().toLocaleTimeString();

            // Show manual copy dialog
            showManualCopyDialog(testText);

            results.textContent = `‚ÑπÔ∏è Manual copy dialog opened.\nText to copy: "${testText}"`;
            results.className = 'result info';
        }

        function showManualCopyDialog(text) {
            const modal = document.createElement('div');
            modal.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: rgba(0, 0, 0, 0.5);
                z-index: 10000;
                display: flex;
                align-items: center;
                justify-content: center;
            `;

            const dialog = document.createElement('div');
            dialog.style.cssText = `
                background: white;
                padding: 20px;
                border-radius: 8px;
                max-width: 500px;
                max-height: 400px;
                overflow: auto;
                box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
            `;

            dialog.innerHTML = `
                <h3 style="margin: 0 0 10px 0;">Copy Text Manually</h3>
                <p style="margin: 0 0 10px 0; color: #666;">Please select and copy the text below:</p>
                <textarea readonly style="width: 100%; height: 200px; padding: 8px; border: 1px solid #ddd; border-radius: 4px; font-family: monospace; font-size: 12px;">${text}</textarea>
                <div style="margin-top: 10px; text-align: right;">
                    <button id="close-manual-copy" style="padding: 8px 16px; background: #4CAF50; color: white; border: none; border-radius: 4px; cursor: pointer;">Close</button>
                </div>
            `;

            modal.appendChild(dialog);
            document.body.appendChild(modal);

            // Add event listener for close button
            const closeBtn = dialog.querySelector('#close-manual-copy');
            closeBtn.addEventListener('click', () => {
                modal.remove();
            });

            // Auto-select the text
            const textarea = dialog.querySelector('textarea');
            textarea.focus();
            textarea.select();
        }

        async function testVMDAIClipboard() {
            const results = document.getElementById('vmdai-results');
            const testText = 'VMD-AI Integration Test - ' + new Date().toLocaleTimeString();

            results.textContent = 'Testing VMD-AI clipboard function...';
            results.className = 'result info';

            try {
                await copyToClipboardFallback(testText);
                results.textContent = `‚úÖ SUCCESS: VMD-AI clipboard function worked!\nText copied: "${testText}"`;
                results.className = 'result success';
            } catch (error) {
                results.textContent = `‚ùå FAILED: ${error.message}`;
                results.className = 'result error';
            }
        }

        // VMD-AI clipboard function (copied from sidebar.js)
        async function copyToClipboardFallback(text) {
            // Try modern Clipboard API first (if available and permitted)
            if (navigator.clipboard && window.isSecureContext) {
                try {
                    await navigator.clipboard.writeText(text);
                    console.log('Text copied using Clipboard API');
                    return;
                } catch (err) {
                    console.log('Clipboard API failed, using fallback:', err.message);
                }
            }

            // Fallback to execCommand for restricted environments
            const textArea = document.createElement('textarea');
            textArea.value = text;

            // Make it invisible but accessible
            textArea.style.position = 'fixed';
            textArea.style.left = '-999999px';
            textArea.style.top = '-999999px';
            textArea.style.opacity = '0';
            textArea.style.pointerEvents = 'none';
            textArea.setAttribute('readonly', '');
            textArea.setAttribute('tabindex', '-1');

            // Add to DOM, select, copy, remove
            document.body.appendChild(textArea);
            textArea.focus();
            textArea.select();
            textArea.setSelectionRange(0, text.length);

            try {
                // Use the legacy method for compatibility
                document.execCommand('copy');
                console.log('Text copied using execCommand fallback');
            } catch (err) {
                console.error('All copy methods failed:', err);
                // Show user a manual copy option
                showManualCopyDialog(text);
                throw new Error('Automatic copy failed, manual dialog shown');
            }

            document.body.removeChild(textArea);
        }
    </script>
</body>
</html>
